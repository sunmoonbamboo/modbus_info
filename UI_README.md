# Modbus协议信息提取工具 - Web UI 使用说明

## 简介

本工具提供了一个基于 Gradio 的 Web UI 界面，可以方便地上传 Modbus 协议 PDF 文件并自动提取关键点位信息。

## 安装依赖

### 使用 uv（推荐）

```powershell
# 安装依赖
uv sync

# 如果需要安装 MinerU
uv pip install "mineru[core]"
```

### 使用 pip

```powershell
pip install -r requirements.txt
```

## 启动 Web UI

### 方式 1：使用启动脚本

```powershell
# 使用 uv
uv run python run_ui.py

# 或直接使用 python
python run_ui.py
```

### 方式 2：直接运行 app.py

```powershell
# 使用 uv
uv run python app.py

# 或直接使用 python
python app.py
```

启动后，浏览器会自动打开，或手动访问：`http://localhost:7860`

## 使用步骤

### 1️⃣ 上传协议文件

- 点击 "选择PDF文件" 按钮
- 选择您的 Modbus 协议 PDF 文件
- 系统仅接受 PDF 格式，其他格式会提示错误
- 上传成功后，文件会保存到 `data/src` 目录

### 2️⃣ 配置参数

#### 控制器名称（必填）
- 输入您的控制器名称，例如：`default`, `controller_01` 等
- 此名称会用于标识设备

#### 地址偏移量（可选）
- 默认值为 0
- 取值范围：[0, 10)
- 用于调整 Modbus 地址的偏移

### 3️⃣ 配置点位信息

系统会显示默认的点位配置，格式为 JSON：

```json
{
  "查询冷冻水进水温度采集": "SPcoolTwIn",
  "查询冷冻水出水温度采集": "SPcoolTwOut",
  "查询热水进水温度采集": "SPheatTwIn",
  ...
}
```

您可以：
- ✏️ **修改**现有点位的描述或编码
- ➕ **添加**新的点位（按 JSON 格式）
- ➖ **删除**不需要的点位

### 4️⃣ 开始提取

点击 **"🚀 开始提取"** 按钮，系统会自动执行：

1. **解析 PDF 文件**
   - 将 PDF 转换为 Markdown 格式
   - 或使用已有的 Markdown 文件

2. **AI 提取点位信息**
   - 使用 AI 模型分析协议内容
   - 提取所有配置的点位信息

3. **生成 CSV 文件**
   - 将提取结果导出为 CSV 格式
   - 文件保存在 `data/output` 目录

### 5️⃣ 查看和下载结果

- **提取过程**：右侧文本框会实时显示处理进度
- **结果表格**：提取完成后会显示所有点位信息
- **下载按钮**：点击 "📥 下载CSV文件" 保存结果到本地

## 界面预览

```
┌─────────────────────────────────────────────────────────────┐
│  📋 Modbus协议信息提取工具                                    │
├─────────────────────────┬───────────────────────────────────┤
│  左侧：输入区            │  右侧：输出区                      │
│  ├─ 1️⃣ 上传文件         │  ├─ 📊 提取结果                   │
│  ├─ 2️⃣ 配置参数         │  ├─ 提取过程显示                  │
│  ├─ 3️⃣ 点位配置         │  ├─ 结果表格                      │
│  └─ 🚀 开始提取         │  └─ 📥 下载按钮                   │
└─────────────────────────┴───────────────────────────────────┘
```

## 注意事项

1. **文件格式**：仅支持 PDF 格式的文件
2. **处理时间**：提取过程可能需要几分钟，取决于文件大小和复杂度
3. **API 配置**：确保 `.env` 文件中已配置正确的 API 密钥
4. **日志文件**：运行日志保存在 `logs/gradio_app_{time}.log`

## 配置文件

- **`.env`**：API 密钥和模型配置
- **`config/modbus_extract.md`**：默认点位配置
- **`config/dev_mapping.json`**：设备映射配置（会根据 UI 输入自动更新）

## 故障排查

### 问题：无法上传文件
- **检查**：确认文件是 PDF 格式
- **检查**：确认 `data/src` 目录存在且有写入权限

### 问题：提取失败
- **检查**：查看 `logs` 目录中的日志文件
- **检查**：确认 API 密钥配置正确
- **检查**：确认网络连接正常

### 问题：点位配置格式错误
- **确保**：JSON 格式正确（使用引号、逗号等）
- **参考**：默认配置的格式

## 命令行版本

如果您仍然需要使用命令行版本，请参考项目根目录的 `README.md` 文件。

命令行示例：
```powershell
# 单文件处理
uv run python main.py data/src/protocol.pdf -c controller_name --address-offset 0

# 批量处理
uv run python main.py data/src --batch -c controller_name
```

## 技术支持

如有问题，请查看：
- 项目文档：`README.md`
- 配置说明：`config/modbus_extract.md`
- 日志文件：`logs/` 目录

